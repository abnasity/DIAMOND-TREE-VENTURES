{% extends 'layouts/base.html' %}

{% block content %}
<h2 class="mt-4">Assigned Orders</h2>

{% if orders %}
    <div class="table-responsive mt-3">
        <table class="table table-striped table-hover align-middle">
            <thead class="table-dark">
                <tr>
                    <th scope="col" class="text-primary">#Order ID</th>
                    <th scope="col" class="text-primary">Customer</th>
                    <th scope="col" class="text-primary">Status</th>
                    <th scope="col" class="text-primary">Created At</th>
                    <th scope="col" class="text-primary">Delivery Address</th>
                    <th scope="col" class="text-primary">Payment Option</th>
                    <th scope="col" class="text-primary">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                    <tr>
                        <td>#{{ order.id }}</td>
                        <td>{{ order.customer.full_name }}</td>
                        <td>
                            <span class="badge fs-6 bg-{{ 
                                'secondary' if order.status == 'pending' else 
                                'primary' if order.status == 'awaiting_approval' else 
                                'success' if order.status == 'approved' else 
                                'danger' if order.status == 'cancelled' else 'dark'
                            }}">{{ order.status | capitalize }}</span>
                        </td>
                        <td>{{ order.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td>{{ order.delivery_address }}</td>
                        <td>{{ order.payment_option }}</td>

                        <td>
                        <a href="{{ url_for('auth.view_order_staff', order_id=order.id) }}" class="btn btn-sm btn-primary">
                            <i class="fas fa-eye me-1"></i> View
                        </a>

                        {% if order.status == 'approved' %}
                      <form action="{{ url_for('staff.mark_task_failed', order_id=order.id) }}" method="POST" style="display:inline;">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    
    <div class="mb-3">
        <label for="failureReason" class="form-label fw-semibold">Failure Reason *</label>
        <textarea 
            id="failureReason" 
            name="reason" 
            class="form-control" 
            rows="3" 
            required
            placeholder="Please specify the reason for task failure..."
        ></textarea>
    </div>

    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
        <button 
            type="submit" 
            class="btn btn-danger px-4"
            onclick="return confirm('Are you sure you want to mark this task as failed? This action cannot be undone.')"
        >
            <i class="fas fa-times-circle me-2"></i> Mark as Failed
        </button>
    </div>
</form>

                        {% endif %}
                    </td>

                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <p class="text-muted mt-3">No orders have been assigned to you.</p>
{% endif %}
{% endblock %}
